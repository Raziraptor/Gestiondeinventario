{% extends 'base.html' %}

{% block title %}Detalle de: {{ producto.nombre }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>{{ producto.nombre }}</h2>
            <h5 class="text-muted">SKU: {{ producto.codigo }}</h5>
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    Total Global
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h1 class="display-4 fw-bold text-primary">{{ total_global }}</h1>
                    <small class="text-muted">Unidades en total</small>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    Distribución por Almacén
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-striped mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Almacén</th>
                                <th class="text-end">Stock Actual</th>
                                <th class="text-center">Niveles (Mín / Máx)</th>
                                <th class="text-end">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks_actuales %}
                            <tr>
                                <td>
                                    <i class="bi bi-house-door-fill text-secondary"></i> 
                                    {{ stock.almacen.nombre }}
                                </td>
                                <td class="text-end">
                                    <span class="badge fs-6 
                                        {% if stock.cantidad < stock.stock_minimo %}bg-danger
                                        {% elif stock.cantidad > stock.stock_maximo %}bg-warning text-dark
                                        {% else %}bg-success{% endif %}">
                                        {{ stock.cantidad }}
                                    </span>
                                </td>
                                <td class="text-center text-muted">
                                    {{ stock.stock_minimo }} / {{ stock.stock_maximo }}
                                </td>
                                <td class="text-end">
                                    <a href="{{ url_for('editar_producto', id=producto.id, almacen_id=stock.almacen_id) }}" 
                                       class="btn btn-sm btn-outline-secondary" title="Ajustar Stock">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    <i class="bi bi-exclamation-circle fs-4"></i><br>
                                    Este producto no está asignado a ningún almacén.<br>
                                    <a href="{{ url_for('lista_productos_sin_almacen') }}">Asignar ahora</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <hr>

    <h3 class="mb-3"><i class="bi bi-clock-history"></i> Historial de Movimientos</h3>
    
    {% if not historial_por_almacen %}
        <div class="alert alert-light border text-center py-4">
            No hay movimientos registrados para este producto todavía.
        </div>
    {% endif %}

    <div class="accordion" id="accordionHistorial">
        {% for almacen_nombre, movimientos in historial_por_almacen.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <strong>{{ almacen_nombre }}</strong> &nbsp; <span class="badge bg-secondary rounded-pill">{{ movimientos|length }} movs</span>
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" data-bs-parent="#accordionHistorial">
                <div class="accordion-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th class="text-end">Cant.</th>
                                <th>Referencia / Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in movimientos %}
                            <tr>
                                <td>{{ mov.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if 'entrada' in mov.tipo %}
                                        <span class="text-success"><i class="bi bi-arrow-down-circle"></i> Entrada</span>
                                    {% else %}
                                        <span class="text-danger"><i class="bi bi-arrow-up-circle"></i> Salida</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {{ 'text-success' if mov.cantidad > 0 else 'text-danger' }}">
                                    {{ mov.cantidad }}
                                </td>
                                <td>
                                    <small>
                                    {% if mov.orden_compra_id %}
                                        <a href="{{ url_for('ver_orden', id=mov.orden_compra_id) }}">OC #{{ mov.orden_compra_id }}</a>
                                    {% elif mov.salida_id %}
                                        <a href="{{ url_for('ver_salida', id=mov.salida_id) }}">Salida #{{ mov.salida_id }}</a>
                                    {% endif %}
                                    {{ mov.motivo }}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

{% endblock %}
