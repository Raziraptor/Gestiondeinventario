{% extends 'base.html' %}

{% block title %}Historial de Órdenes{% endblock %}

{% block content %}
    <!-- ENCABEZAO PRINCIPAL -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-journal-text"></i> Historial de Órdenes</h2>
            <p class="text-muted mb-0">Consulta, filtra y gestiona el estado de tus compras.</p>
        </div>
        <!-- Botón de la nueva función Manual -->
        <a href="{{ url_for('nueva_orden_manual') }}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-circle-fill"></i> Crear OC Manual
        </a>
    </div>

    <!-- SECCIÓN DE FILTROS (Recuperada de tu archivo subido) -->
    <div class="card bg-light mb-4 shadow-sm border-0">
        <div class="card-body py-3">
            <form method="GET" action="{{ url_for('lista_ordenes') }}" class="row g-2 align-items-end">
                
                <div class="col-md-3">
                    <label for="mes" class="form-label fw-bold small text-muted">Mes</label>
                    <select id="mes" name="mes" class="form-select form-select-sm">
                        {% set meses = [
                            (1, 'Enero'), (2, 'Febrero'), (3, 'Marzo'), (4, 'Abril'),
                            (5, 'Mayo'), (6, 'Junio'), (7, 'Julio'), (8, 'Agosto'),
                            (9, 'Septiembre'), (10, 'Octubre'), (11, 'Noviembre'), (12, 'Diciembre')
                        ] %}
                        {% for num, nombre in meses %}
                            <option value="{{ num }}" {% if request.args.get('mes')|int == num %}selected{% endif %}>
                                {{ nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="ano" class="form-label fw-bold small text-muted">Año</label>
                    <input type="number" id="ano" name="ano" class="form-control form-control-sm" 
                           value="{{ request.args.get('ano', 2025) }}" min="2020" max="2050">
                </div>
                
                <div class="col-md-4">
                    <label for="proveedor_id" class="form-label fw-bold small text-muted">Proveedor</label>
                    <select id="proveedor_id" name="proveedor_id" class="form-select form-select-sm">
                        <option value="0">-- Todos --</option>
                        <!-- Asumiendo que 'proveedores' se pasa al template -->
                        {% for prov in proveedores %} 
                            <option value="{{ prov.id }}" {% if request.args.get('proveedor_id')|int == prov.id %}selected{% endif %}>
                                {{ prov.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-secondary btn-sm">
                        <i class="bi bi-filter"></i> Filtrar Resultados
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- GRID DE ÓRDENES -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
        {% for orden in ordenes %}
            
            <!-- Definición de estilos según estado (Diseño Visual) -->
            {% set borde_top = 'border-top: 4px solid #6c757d;' %}
            {% set badge_class = 'bg-secondary' %}
            
            {% if orden.estado == 'Pendiente' %}
                {% set borde_top = 'border-top: 4px solid #ffc107;' %}
                {% set badge_class = 'bg-warning text-dark' %}
            {% elif orden.estado == 'Enviada' %}
                {% set borde_top = 'border-top: 4px solid #0d6efd;' %}
                {% set badge_class = 'bg-primary' %}
            {% elif orden.estado == 'Recibida' %}
                {% set borde_top = 'border-top: 4px solid #198754;' %}
                {% set badge_class = 'bg-success' %}
            {% elif orden.estado == 'Cancelada' %}
                {% set borde_top = 'border-top: 4px solid #dc3545;' %}
                {% set badge_class = 'bg-danger' %}
            {% endif %}

            <div class="col">
                <div class="card h-100 shadow-sm border-0" style="{{ borde_top }}">
                    <div class="card-body">
                        
                        <!-- Header Tarjeta -->
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                <h5 class="card-title fw-bold mb-0">Orden #{{ orden.id }}</h5>
                                <small class="text-muted">{{ orden.fecha_creacion.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <span class="badge {{ badge_class }} align-self-start">{{ orden.estado }}</span>
                        </div>

                        <!-- Detalles -->
                        <div class="mb-3">
                            <h6 class="text-primary fw-bold mb-1">
                                <i class="bi bi-building"></i> {{ orden.proveedor.nombre }}
                            </h6>
                            <small class="text-muted d-block">
                                <i class="bi bi-person"></i> {{ orden.usuario.nombre if orden.usuario else 'Sistema' }}
                            </small>
                            {% if orden.almacen %}
                                <small class="text-muted d-block">
                                    <i class="bi bi-geo-alt"></i> {{ orden.almacen.nombre }}
                                </small>
                            {% endif %}
                        </div>

                        <!-- Total Calculado -->
                        {% set ns = namespace(total=0) %}
                        {% for d in orden.detalles %}
                            {% set ns.total = ns.total + (d.cantidad_solicitada * d.costo_unitario_estimado) %}
                        {% endfor %}
                        
                        <div class="bg-light p-2 rounded text-center mb-3 border">
                            <span class="text-muted small text-uppercase">Total Estimado</span>
                            <div class="fw-bold fs-5">${{ "%.2f"|format(ns.total) }}</div>
                        </div>

                        <!-- BOTONES DE FUNCIÓN (Lo que pediste recuperar) -->
                        <div class="d-grid gap-2">
                            
                            {% if orden.estado == 'Pendiente' %}
                                <!-- Botón Enviar (Requiere ruta 'enviar_orden' o similar en backend) -->
                                <!-- Si no existe la ruta, puedes usar un link a editar para cambiar estado manualmente -->
                                <a href="{{ url_for('editar_orden', id=orden.id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-send"></i> Gestionar / Enviar
                                </a>

                                <!-- Botón Cancelar (Usa nuestra nueva lógica de eliminar_orden) -->
                                <form action="{{ url_for('eliminar_orden', id=orden.id) }}" method="POST" 
                                      onsubmit="return confirm('¿Cancelar esta orden? Se eliminará permanentemente.');">
                                    <button type="submit" class="btn btn-warning btn-sm w-100 text-dark">
                                        <i class="bi bi-x-circle"></i> Cancelar Orden
                                    </button>
                                </form>

                            {% elif orden.estado == 'Enviada' %}
                                <!-- Botón Recibir -->
                                <a href="{{ url_for('ver_orden', id=orden.id) }}" class="btn btn-success btn-sm">
                                    <i class="bi bi-box-seam"></i> Recibir Mercancía
                                </a>

                            {% elif orden.estado == 'Recibida' %}
                                <div class="alert alert-success py-1 px-2 small text-center mb-0">
                                    <i class="bi bi-check-all"></i> Completada
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- FOOTER: Herramientas Fijas (PDF, Ver) -->
                    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <a href="{{ url_for('ver_orden', id=orden.id) }}" class="btn btn-link text-secondary p-0 me-2" title="Ver Detalle">
                                <i class="bi bi-eye fs-5"></i>
                            </a>
                            <a href="{{ url_for('generar_oc_pdf', id=orden.id) }}" class="btn btn-link text-secondary p-0" title="Descargar PDF" target="_blank">
                                <i class="bi bi-file-pdf fs-5"></i>
                            </a>
                        </div>
                        
                        <!-- Opción de Borrar Historial (Solo si está terminada/cancelada) -->
                        {% if orden.estado in ['Recibida', 'Cancelada'] %}
                            <form action="{{ url_for('eliminar_orden', id=orden.id) }}" method="POST" class="d-inline"
                                  onsubmit="return confirm('¿Borrar del historial?');">
                                <button type="submit" class="btn btn-link text-muted p-0" title="Borrar Historial">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center py-5">
                <i class="bi bi-filter-circle text-muted opacity-25" style="font-size: 4rem;"></i>
                <p class="mt-3 text-muted">No se encontraron órdenes con estos filtros.</p>
                <a href="{{ url_for('lista_ordenes') }}" class="btn btn-outline-secondary btn-sm">Limpiar Filtros</a>
            </div>
        {% endfor %}
    </div>
{% endblock %}
