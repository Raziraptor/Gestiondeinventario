{% extends 'base.html' %}

{% block title %}Órdenes de Compra{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Historial de Órdenes de Compra</h2>
        <a href="{{ url_for('nueva_orden_manual') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Crear OC Manual
        </a>
    </div>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('lista_ordenes') }}" class="row g-3 align-items-end">
                
                <div class="col-md-3">
                    <label for="mes" class="form-label">Mes</label>
                    <select id="mes" name="mes" class="form-select">
                        {% for num, nombre in meses_lista %}
                            <option value="{{ num }}" {% if num == mes_seleccionado %}selected{% endif %}>
                                {{ nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="ano" class="form-label">Año</label>
                    <input type="number" id="ano" name="ano" class="form-control" value="{{ ano_seleccionado }}" min="2020" max="2050">
                </div>
                
                <div class="col-md-4">
                    <label for="proveedor_id" class="form-label">Proveedor</label>
                    <select id="proveedor_id" name="proveedor_id" class="form-select">
                        <option value="0">-- Todos los Proveedores --</option>
                        {% for prov in proveedores %}
                            <option value="{{ prov.id }}" {% if prov.id == prov_seleccionado %}selected{% endif %}>
                                {{ prov.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-filter"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% for orden in ordenes %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center 
                    {% if orden.estado == 'recibida' %}bg-success text-white
                    {% elif orden.estado == 'enviada' %}bg-info text-dark
                    {% elif orden.estado == 'cancelada' %}bg-secondary
                    {% else %}bg-warning text-dark{% endif %}">
            <div>
                <strong>OC #{{ orden.id }}</strong> - Proveedor: <strong>{{ orden.proveedor.nombre }}</strong>
                <br>
                <small>Creada: {{ orden.fecha_creacion.strftime('%Y-%m-%d') }}</small>
            </div>
            <h4>
                Estado: <span class="badge 
                                {% if orden.estado == 'recibida' %}bg-light text-success
                                {% elif orden.estado == 'enviada' %}bg-dark
                                {% elif orden.estado == 'cancelada' %}bg-light text-dark
                                {% else %}bg-warning text-dark{% endif %}">
                    {{ orden.estado.capitalize() }}
                </span>
            </h4>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-6">
                    <small class="text-muted">
                        Creada por: <i class="bi bi-person"></i> {{ orden.creador.username }}
                    </small>
                </div>
                {% if orden.estado == 'cancelada' and orden.cancelado_por %}
                <div class="col-md-6">
                    <small class="text-muted">
                        Cancelada por: <i class="bi bi-person-x"></i> {{ orden.cancelado_por.username }}
                    </small>
                </div>
                {% endif %}
            </div>
            <h5 class="card-title">Detalles de la Orden</h5>
            <table class="table table-sm">
                <tbody>
                    {% for detalle in orden.detalles %}
                    <tr>
                        <td>{{ detalle.producto.nombre }}</td>
                        <td class="text-end">{{ detalle.cantidad_solicitada }} (uds)</td>
                        <td class="text-end">${{ "%.2f"|format(detalle.subtotal) }} (Est.)</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-group-divider">
                        <td colspan="2" class="text-end"><strong>Total Estimado:</strong></td>
                        <td class="text-end"><strong>${{ "%.2f"|format(orden.costo_total) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="card-footer text-end">
            <a href="{{ url_for('ver_orden', id=orden.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-eye"></i> Ver Detalle
            </a>
            <a href="{{ url_for('generar_oc_pdf', id=orden.id) }}" class="btn btn-outline-danger" title="Imprimir PDF" target="_blank">
                <i class="bi bi-file-earmark-pdf"></i>
            </a>
            {% if orden.estado == 'borrador' %}
                <a href="{{ url_for('editar_orden', id=orden.id) }}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                <form action="{{ url_for('enviar_orden', id=orden.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-info">Marcar como "Enviada"</button>
                </form>
                <form action="{{ url_for('cancelar_orden', id=orden.id) }}" method="POST" style="display: inline;" 
                      onsubmit="return confirm('¿Estás seguro de que deseas cancelar esta orden?');">
                    <button type="submit" class="btn btn-warning" title="Cancelar Orden">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </form>
            {% elif orden.estado == 'enviada' %}
            <form action="{{ url_for('recibir_orden', id=orden.id) }}" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-success">Marcar como "Recibida"</button>
            </form>
            {% elif orden.estado == 'recibida' %}
            <span class="text-success">Recibida el {{ orden.fecha_recepcion.strftime('%Y-%m-%d') }}</span>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        No se encontraron Órdenes de Compra para <strong>{{ meses_lista[mes_seleccionado-1][1] }} de {{ ano_seleccionado }}</strong>
        {% if prov_seleccionado != 0 %}
            y el proveedor seleccionado.
        {% else %}
            .
        {% endif %}
    </div>
    {% endfor %}

{% endblock %}