{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ titulo }}</h2>
        <a href="{{ url_for('ver_salida', id=salida_id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-eye"></i> Ver Hoja de Salida de Hoy
        </a>
    </div>
    <p class="text-muted">
        Añade items a la hoja de salida del día. Los items se restarán del almacén: <strong>{{ almacen.nombre }}</strong>
    </p>
    <hr>
    
    <form method="POST" action="{{ url_for('registrar_salida', almacen_id=almacen.id) }}">
        
        <h4>Productos a Retirar</h4>
        <div id="lineas_productos_container">
            </div>
        
        <button type="button" id="btn_add_producto" class="btn btn-info mt-2">
            <i class="bi bi-plus-circle"></i> Añadir Producto
        </button>
        
        <hr class="my-4">
        <div class="col-12">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-box-arrow-up"></i> Registrar Salida
            </button>
            <a href="{{ url_for('historial_salidas') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <template id="plantilla_linea">
        <div class="row g-3 mb-3 p-2 border rounded bg-light producto-linea">
            <div class="col-md-5">
                <label class="form-label">Producto</label>
                <select name="producto_id[]" class="form-select" required>
                    <option value="">-- Selecciona un producto --</option>
                    </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cantidad</label>
                <input type="number" name="cantidad[]" class="form-control" value="1" min="1" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Motivo</label>
                <input type="text" name="motivo[]" class="form-control" placeholder="Ej: Venta, Merma" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100" onclick="eliminarLinea(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </template>

    <script>
        // (Ignora el falso error de VS Code en esta línea)
        var productos = {{ productos | tojson | safe }};

        function eliminarLinea(boton) {
            boton.closest('.producto-linea').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const contenedor = document.getElementById('lineas_productos_container');
            const plantilla = document.getElementById('plantilla_linea');
            
            function anadirNuevaLinea() {
                const nuevaLinea = plantilla.content.firstElementChild.cloneNode(true);
                const selectProducto = nuevaLinea.querySelector('select[name="producto_id[]"]');
                
                productos.forEach(function(producto) {
                    const opcion = new Option(
                        `${producto.nombre} (Stock: ${producto.stock_actual})`, 
                        producto.id
                    );
                    selectProducto.add(opcion);
                });

                contenedor.appendChild(nuevaLinea);
            }

            document.getElementById('btn_add_producto').addEventListener('click', anadirNuevaLinea);
            
            // Cargar la primera línea automáticamente
            anadirNuevaLinea();
        });
    </script>
{% endblock %}
