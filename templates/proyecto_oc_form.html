{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <h2>{{ titulo }}</h2>
    <hr>
    
    <form method="POST" action="{{ url_for('editar_proyecto_oc', id=proyecto_oc.id) if proyecto_oc else url_for('nuevo_proyecto_oc') }}">
        
        <div class="row">
            <div class="mb-3 col-md-6">
                <label for="nombre_proyecto" class="form-label">Nombre del Proyecto</label>
                <input type="text" class="form-control" id="nombre_proyecto" name="nombre_proyecto" 
                       value="{{ proyecto_oc.nombre_proyecto if proyecto_oc else '' }}" required>
            </div>
            
            <div class="mb-3 col-md-6">
                <label for="almacen_id" class="form-label">Almacén de Destino</label>
                <select class="form-select" id="almacen_id" name="almacen_id" 
                        {% if proyecto_oc %}disabled{% endif %} required>
                    <option value="">-- Selecciona un almacén --</option>
                    {% for alm in almacenes %}
                        <option value="{{ alm.id }}" 
                                {% if proyecto_oc and proyecto_oc.almacen_id == alm.id %}selected{% endif %}>
                            {{ alm.nombre }}
                        </option>
                    {% endfor %}
                </select>
                {% if proyecto_oc %}
                    <input type="hidden" name="almacen_id" value="{{ proyecto_oc.almacen_id }}">
                    <small class="form-text text-muted">No se puede cambiar el almacén de una orden existente.</small>
                {% endif %}
            </div>
        </div>
        
        <hr>
        
        <h4>Items</h4>
        <div id="lineas_items_container">
            </div>
        
        <button type="button" id="btn_add_item" class="btn btn-info mt-2">
            <i class="bi bi-plus-circle"></i> Añadir Item
        </button>
        
        <hr class="my-4">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Guardar OC de Proyecto</button>
            <a href="{{ url_for('lista_proyectos_oc') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <template id="plantilla_linea">
        <div class="row g-3 mb-3 p-2 border rounded bg-light item-linea">
            <div class="col-md-5">
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_existente_X" value="existente">
                        <label class="form-check-label" for="tipo_existente_X">Producto Existente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_nuevo_X" value="nuevo">
                        <label class="form-check-label" for="tipo_nuevo_X">Producto Nuevo</label>
                    </div>
                    <input type="hidden" class="tipo-item-hidden" name="tipo_item[]" value="existente">
                </div>
                
                <div class="control-existente">
                    <label class="form-label">Producto del Inventario</label>
                    <input class="form-control producto-search" list="datalistProductos" name="producto_nombre_existente_visual[]" placeholder="Escribe para buscar..." autocomplete="off">
                    <input type="hidden" class="producto-id-hidden" name="producto_id_existente[]" value="0">
                </div>
                
                <div class="control-nuevo" style="display: none;">
                    <label class="form-label">Descripción del Producto Nuevo</label>
                    <input type="text" name="producto_nuevo_descripcion[]" class="form-control" disabled>
                    <input type="hidden" name="producto_id_existente[]" value="0" disabled>
                </div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Proveedor Sugerido</label>
                <input class="form-control proveedor-search" list="datalistProveedores" name="proveedor_sugerido[]" placeholder="Escribe o selecciona...">
            </div>
            
            <div class="col-md-4">
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="cantidad[]" class="form-control cantidad-input" value="1" min="1" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Costo Unit.</label>
                        <input type="number" name="costo[]" class="form-control costo-input" value="0.00" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarLinea(this)">
                    <i class="bi bi-trash"></i> Eliminar Línea
                </button>
            </div>
        </div>
    </template>

    <datalist id="datalistProductos"></datalist>
    <datalist id="datalistProveedores"></datalist>

    <script>
        let lineaCounter = 0;
        // Mapas para búsqueda rápida
        const productosMap = new Map();     // Nombre -> {id, precio}
        const productosIdMap = new Map();   // ID -> Nombre

        // Función global para el botón de eliminar
        function eliminarLinea(boton) {
            boton.closest('.item-linea').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Iniciando script de Proyecto OC...");

            // 1. Cargar datos de forma SEGURA usando tojson
            const productosData = {{ productos | tojson | safe }};
            const proveedoresData = {{ proveedores | tojson | safe }};
            const detallesExistentes = {{ detalles_json | tojson | safe }};

            // 2. Llenar Datalists y Mapas
            const datalistProductos = document.getElementById('datalistProductos');
            productosData.forEach(p => {
                const nombreCompleto = `${p.nombre} (SKU: ${p.codigo})`;
                // Llenar mapas
                productosMap.set(nombreCompleto, { id: p.id, precio: p.precio_unitario });
                productosIdMap.set(p.id, nombreCompleto);
                // Llenar datalist
                const option = document.createElement('option');
                option.value = nombreCompleto;
                datalistProductos.appendChild(option);
            });

            const datalistProveedores = document.getElementById('datalistProveedores');
            proveedoresData.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.nombre;
                datalistProveedores.appendChild(option);
            });

            // 3. Función Principal: Añadir Línea
            const contenedor = document.getElementById('lineas_items_container');
            const plantilla = document.getElementById('plantilla_linea');

            function anadirNuevaLinea(detalle = null) {
                lineaCounter++;
                const nuevaLinea = plantilla.content.firstElementChild.cloneNode(true);

                // --- A. Configurar IDs únicos para los Radios ---
                const radioName = `tipo_item_group_${lineaCounter}`;
                const radioExistente = nuevaLinea.querySelector('#tipo_existente_X');
                const radioNuevo = nuevaLinea.querySelector('#tipo_nuevo_X');
                
                radioExistente.id = `tipo_existente_${lineaCounter}`;
                radioExistente.name = radioName;
                nuevaLinea.querySelector('label[for="tipo_existente_X"]').htmlFor = `tipo_existente_${lineaCounter}`;
                
                radioNuevo.id = `tipo_nuevo_${lineaCounter}`;
                radioNuevo.name = radioName;
                nuevaLinea.querySelector('label[for="tipo_nuevo_X"]').htmlFor = `tipo_nuevo_${lineaCounter}`;

                // --- B. Referencias a elementos ---
                const tipoHidden = nuevaLinea.querySelector('.tipo-item-hidden');
                const divExistente = nuevaLinea.querySelector('.control-existente');
                const inputSearch = divExistente.querySelector('.producto-search');
                const inputIdHidden = divExistente.querySelector('.producto-id-hidden');
                
                const divNuevo = nuevaLinea.querySelector('.control-nuevo');
                const inputNuevoDesc = divNuevo.querySelector('input[type="text"]');
                const inputNuevoIdDummy = divNuevo.querySelector('input[type="hidden"]');

                const inputCosto = nuevaLinea.querySelector('.costo-input');
                const inputCantidad = nuevaLinea.querySelector('.cantidad-input');
                const inputProveedor = nuevaLinea.querySelector('.proveedor-search');

                // --- C. Lógica de Cambio de Tipo ---
                function cambiarTipo(tipo) {
                    tipoHidden.value = tipo;
                    if (tipo === 'existente') {
                        divExistente.style.display = 'block';
                        inputSearch.disabled = false;
                        inputSearch.required = true;
                        inputIdHidden.disabled = false;

                        divNuevo.style.display = 'none';
                        inputNuevoDesc.disabled = true;
                        inputNuevoDesc.required = false;
                        inputNuevoIdDummy.disabled = true;
                        
                        // Intentar re-rellenar precio si ya había algo seleccionado
                        buscarProducto(inputSearch.value);

                    } else { // tipo === 'nuevo'
                        divExistente.style.display = 'none';
                        inputSearch.disabled = true;
                        inputSearch.required = false;
                        inputIdHidden.disabled = true;

                        divNuevo.style.display = 'block';
                        inputNuevoDesc.disabled = false;
                        inputNuevoDesc.required = true;
                        inputNuevoIdDummy.disabled = false;

                        inputCosto.readOnly = false;
                        if (inputCosto.value === '') inputCosto.value = '0.00';
                    }
                }

                radioExistente.addEventListener('change', () => cambiarTipo('existente'));
                radioNuevo.addEventListener('change', () => cambiarTipo('nuevo'));

                // --- D. Lógica de Búsqueda de Producto ---
                function buscarProducto(valor) {
                    const prodData = productosMap.get(valor);
                    if (prodData) {
                        // Encontrado: Rellenar ID y Costo
                        inputIdHidden.value = prodData.id;
                        inputCosto.value = parseFloat(prodData.precio).toFixed(2);
                        inputCosto.readOnly = true; // Bloquear costo para existentes
                    } else {
                        // No encontrado (aún escribiendo): Limpiar ID
                        inputIdHidden.value = '0';
                        inputCosto.readOnly = false; // Permitir editar costo si no hay match
                    }
                }
                inputSearch.addEventListener('input', (e) => buscarProducto(e.target.value));

                // --- E. Pre-rellenar datos (si es edición) ---
                if (detalle) {
                    inputCantidad.value = detalle.cantidad;
                    inputCosto.value = parseFloat(detalle.costo_unitario).toFixed(2);
                    inputProveedor.value = detalle.proveedor_sugerido || '';
                    
                    if (detalle.tipo === 'existente') {
                        radioExistente.checked = true;
                        cambiarTipo('existente');
                        // Buscar nombre por ID y rellenar
                        const nombre = productosIdMap.get(detalle.producto_id);
                        if (nombre) {
                            inputSearch.value = nombre;
                            inputIdHidden.value = detalle.producto_id;
                            inputCosto.readOnly = true;
                        }
                    } else {
                        radioNuevo.checked = true;
                        cambiarTipo('nuevo');
                        inputNuevoDesc.value = detalle.descripcion_nuevo;
                    }
                } else {
                    // Nueva línea por defecto
                    radioExistente.checked = true;
                    cambiarTipo('existente');
                }

                contenedor.appendChild(nuevaLinea);
            }

            // --- 4. Inicialización ---
            document.getElementById('btn_add_item').addEventListener('click', () => anadirNuevaLinea());

            if (detallesExistentes && detallesExistentes.length > 0) {
                console.log("Cargando detalles existentes:", detallesExistentes.length);
                detallesExistentes.forEach(detalle => anadirNuevaLinea(detalle));
            } else {
                console.log("Cargando línea vacía inicial.");
                anadirNuevaLinea();
            }
        });
    </script>
{% endblock %}
