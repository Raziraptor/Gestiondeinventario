{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <h2>{{ titulo }}</h2>
    <hr>
    
    <form method="POST" action="{{ url_for('editar_proyecto_oc', id=proyecto_oc.id) if proyecto_oc else url_for('nuevo_proyecto_oc') }}">
        
        <div class="row">
            <div class="mb-3 col-md-6">
                <label for="nombre_proyecto" class="form-label">Nombre del Proyecto</label>
                <input type="text" class="form-control" id="nombre_proyecto" name="nombre_proyecto" 
                       value="{{ proyecto_oc.nombre_proyecto if proyecto_oc else '' }}" required>
            </div>
            
            <div class="mb-3 col-md-6">
                <label for="almacen_id" class="form-label">Almacén de Destino</label>
                <select class="form-select" id="almacen_id" name="almacen_id" 
                        {% if proyecto_oc %}disabled{% endif %} required>
                    <option value="">-- Selecciona un almacén --</option>
                    {% for alm in almacenes %}
                        <option value="{{ alm.id }}" 
                                {% if proyecto_oc and proyecto_oc.almacen_id == alm.id %}selected{% endif %}>
                            {{ alm.nombre }}
                        </option>
                    {% endfor %}
                </select>
                {% if proyecto_oc %}
                    <small class="form-text text-muted">No se puede cambiar el almacén de una orden existente.</small>
                {% endif %}
            </div>
        </div>
        
        <hr>
        
        <h4>Items</h4>
        <div id="lineas_items_container">
            </div>
        
        <button type="button" id="btn_add_item" class="btn btn-info mt-2">
            <i class="bi bi-plus-circle"></i> Añadir Item
        </button>
        
        <hr class="my-4">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Guardar OC de Proyecto</button>
            <a href="{{ url_for('lista_proyectos_oc') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <template id="plantilla_linea">
        <div class="row g-3 mb-3 p-2 border rounded bg-light item-linea">
            <div class="col-md-5">
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_existente_X" value="existente">
                        <label class="form-check-label" for="tipo_existente_X">Producto Existente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_nuevo_X" value="nuevo">
                        <label class="form-check-label" for="tipo_nuevo_X">Producto Nuevo</label>
                    </div>
                    <input type="hidden" class="tipo-item-hidden" name="tipo_item[]" value="existente">
                </div>
                
                <div class="control-existente">
                    <label class="form-label">Producto del Inventario</label>
                    <input class="form-control producto-search" list="datalistProductos" name="producto_nombre_existente[]" placeholder="Escribe para buscar..." autocomplete="off">
                    <input type="hidden" class="producto-id-hidden" name="producto_id_existente[]" value="0">
                </div>
                
                <div class="control-nuevo" style="display: none;">
                    <label class="form-label">Descripción del Producto Nuevo</label>
                    <input type="text" name="producto_nuevo_descripcion[]" class="form-control" disabled>
                    <input type="hidden" name="producto_id_existente[]" value="0" disabled>
                </div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Proveedor (Existente o Nuevo)</label>
                <input class="form-control" list="datalistProveedores" name="proveedor_sugerido[]" placeholder="Escribe o selecciona...">
            </div>
            
            <div class="col-md-4">
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="cantidad[]" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" name="costo[]" class="form-control costo-input" value="0.00" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarLinea(this)">
                    <i class="bi bi-trash"></i> Eliminar Línea
                </button>
            </div>
        </div>
    </template>

    <datalist id="datalistProveedores">
        {% for prov in proveedores %}
            <option value="{{ prov.nombre }}">
        {% endfor %}
    </datalist>
    
    <datalist id="datalistProductos">
        {% for p in productos %}
            <option data-id="{{ p.id }}" data-precio="{{ p.precio_unitario }}" value="{{ p.nombre }} (SKU: {{ p.codigo }})">
        {% endfor %}
    </datalist>

    <script>
        // Contador global para asegurar IDs/Names únicos
        let lineaCounter = 0;
        
        // Ponemos los productos en un mapa de JS para búsqueda rápida (Nombre -> Datos)
        const productosMap = new Map();
        {% for p in productos %}
            productosMap.set("{{ p.nombre }} (SKU: {{ p.codigo }})", { id: {{ p.id }}, precio: {{ p.precio_unitario }} });
        {% endfor %}

        // Mapa inverso (ID -> Nombre/SKU) para rellenar el formulario de edición
        const productosMapById = new Map();
        {% for p in productos %}
            productosMapById.set({{ p.id }}, "{{ p.nombre }} (SKU: {{ p.codigo }})");
        {% endfor %}
        
        // Detalles existentes (solo en modo edición)
        const detallesExistentes = {{ detalles_json | tojson | safe }};

        // Función global para eliminar línea
        function eliminarLinea(boton) {
            boton.closest('.item-linea').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const contenedor = document.getElementById('lineas_items_container');
            const plantilla = document.getElementById('plantilla_linea');
            
            // ========================
            // FUNCIÓN AÑADIR LÍNEA (MODIFICADA)
            // ========================
            function anadirNuevaLinea(detalle = null) {
                lineaCounter++;
                const nuevaLinea = plantilla.content.firstElementChild.cloneNode(true);

                // --- 1. Actualizar IDs y 'name' de radios ---
                nuevaLinea.querySelector('#tipo_existente_X').id = `tipo_existente_${lineaCounter}`;
                nuevaLinea.querySelector('label[for="tipo_existente_X"]').htmlFor = `tipo_existente_${lineaCounter}`;
                nuevaLinea.querySelector('#tipo_nuevo_X').id = `tipo_nuevo_${lineaCounter}`;
                nuevaLinea.querySelector('label[for="tipo_nuevo_X"]').htmlFor = `tipo_nuevo_${lineaCounter}`;
                
                const radioName = `tipo_item_group_${lineaCounter}`;
                nuevaLinea.querySelectorAll('.tipo-item').forEach(radio => radio.name = radioName);
                
                // --- 2. Referencias a los controles ---
                const radios = nuevaLinea.querySelectorAll('.tipo-item');
                const tipoHidden = nuevaLinea.querySelector('.tipo-item-hidden');
                const divExistente = nuevaLinea.querySelector('.control-existente');
                const divNuevo = nuevaLinea.querySelector('.control-nuevo');
                
                const inputExistente = divExistente.querySelector('.producto-search');
                const inputExistenteId = divExistente.querySelector('.producto-id-hidden');
                
                const inputNuevo = divNuevo.querySelector('input');
                const inputNuevoId = divNuevo.querySelector('input[type="hidden"]');
                
                const inputCosto = nuevaLinea.querySelector('.costo-input');
                const inputCantidad = nuevaLinea.querySelector('input[name="cantidad[]"]');
                const inputProveedor = nuevaLinea.querySelector('input[name="proveedor_sugerido[]"]');

                // --- 3. Lógica de cambio de Tipo (Existente vs Nuevo) ---
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        tipoHidden.value = this.value;
                        if (this.value === 'existente') {
                            divExistente.style.display = 'block';
                            inputExistente.disabled = false;
                            inputExistente.required = true;
                            inputExistenteId.disabled = false;
                            
                            divNuevo.style.display = 'none';
                            inputNuevo.disabled = true;
                            inputNuevo.required = false;
                            inputNuevoId.disabled = true;

                            buscarProducto(inputExistente.value);
                            
                        } else if (this.value === 'nuevo') {
                            divExistente.style.display = 'none';
                            inputExistente.disabled = true;
                            inputExistente.required = false;
                            inputExistenteId.disabled = true;
                            
                            divNuevo.style.display = 'block';
                            inputNuevo.disabled = false;
                            inputNuevo.required = true;
                            inputNuevoId.disabled = false;

                            inputCosto.value = '0.00';
                            inputCosto.readOnly = false;
                            inputExistenteId.value = '0';
                        }
                    });
                });
                
                // --- 4. Lógica de búsqueda y auto-rellenado ---
                function buscarProducto(valor) {
                    const producto = productosMap.get(valor);
                    if (producto) {
                        inputExistenteId.value = producto.id;
                        inputCosto.value = parseFloat(producto.precio).toFixed(2);
                        inputCosto.readOnly = true;
                    } else {
                        inputExistenteId.value = '0';
                        inputCosto.readOnly = false;
                    }
                }
                
                inputExistente.addEventListener('input', function() {
                    buscarProducto(this.value);
                });

                // --- 5. LÓGICA DE EDICIÓN (PRE-RELLENAR) ---
                if (detalle) {
                    inputCantidad.value = detalle.cantidad;
                    inputCosto.value = parseFloat(detalle.costo_unitario).toFixed(2);
                    inputProveedor.value = detalle.proveedor_sugerido || '';

                    if (detalle.tipo === 'existente') {
                        nuevaLinea.querySelector('#tipo_existente_X').checked = true;
                        tipoHidden.value = 'existente';
                        
                        const nombreProducto = productosMapById.get(detalle.producto_id);
                        if (nombreProducto) {
                            inputExistente.value = nombreProducto;
                            buscarProducto(nombreProducto);
                        }
                        
                    } else { // Es 'nuevo'
                        nuevaLinea.querySelector('#tipo_nuevo_X').checked = true;
                        tipoHidden.value = 'nuevo';
                        inputNuevo.value = detalle.descripcion_nuevo;
                        inputCosto.readOnly = false;
                        
                        nuevaLinea.querySelector('#tipo_nuevo_X').dispatchEvent(new Event('change'));
                    }
                } else {
                    // Si es nuevo, chequear 'existente' por defecto
                    nuevaLinea.querySelector('#tipo_existente_X').checked = true;
                    tipoHidden.value = 'existente';
                    inputExistente.required = true;
                    inputNuevo.required = false;
                }

                contenedor.appendChild(nuevaLinea);
            }

            // --- 6. LÓGICA DE CARGA INICIAL ---
            document.getElementById('btn_add_item').addEventListener('click', () => anadirNuevaLinea(null));
            
            if (detallesExistentes && detallesExistentes.length > 0) {
                // Modo Edición: Cargar líneas desde la BD
                detallesExistentes.forEach(detalle => {
                    anadirNuevaLinea(detalle);
                });
            } else {
                // Modo Nuevo: Cargar la primera línea vacía
                anadirNuevaLinea(null);
            }
        });
    </script>
{% endblock %}
