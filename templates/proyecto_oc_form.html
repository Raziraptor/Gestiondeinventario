{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <h2>{{ titulo }}</h2>
    <hr>
    
    <form method="POST" action="{{ url_for('nuevo_proyecto_oc') }}">
        
        <!-- 1. NOMBRE DEL PROYECTO -->
        <div class="mb-3 col-md-6">
            <label for="nombre_proyecto" class="form-label">Nombre del Proyecto</label>
            <input type="text" class="form-control" id="nombre_proyecto" name="nombre_proyecto" required>
        </div>
        
        <hr>
        
        <!-- 2. LÍNEAS DE ITEMS DINÁMICAS -->
        <h4>Items</h4>
        <div id="lineas_items_container">
            <!-- La primera línea se añade con JS -->
        </div>
        
        <button type="button" id="btn_add_item" class="btn btn-info mt-2">
            <i class="bi bi-plus-circle"></i> Añadir Item
        </button>
        
        <!-- 3. ACCIONES DEL FORMULARIO -->
        <hr class="my-4">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Guardar OC de Proyecto</button>
            <a href="{{ url_for('lista_proyectos_oc') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <!-- ============================================= -->
    <!-- PLANTILLA JS (oculta) PARA NUEVAS LÍNEAS -->
    <!-- ============================================= -->
    <template id="plantilla_linea">
        <div class="row g-3 mb-3 p-2 border rounded bg-light item-linea">
            <!-- Columna 1: Tipo y Selección -->
            <div class="col-md-5">
                <!-- Tipo de Item (Radio) -->
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_existente_X" value="existente" checked>
                        <label class="form-check-label" for="tipo_existente_X">Producto Existente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tipo-item" type="radio" name="tipo_item_group_X" id="tipo_nuevo_X" value="nuevo">
                        <label class="form-check-label" for="tipo_nuevo_X">Producto Nuevo</label>
                    </div>
                    <input type="hidden" class="tipo-item-hidden" name="tipo_item[]" value="existente">
                </div>
                
                <!-- ======================== -->
                <!-- CAMBIO A INPUT CON DATALIST -->
                <!-- ======================== -->
                <div class="control-existente">
                    <label class="form-label">Producto del Inventario</label>
                    <!-- 1. El Input para buscar -->
                    <input class="form-control producto-search" list="datalistProductos" name="producto_nombre_existente[]" placeholder="Escribe para buscar..." autocomplete="off" required>
                    <!-- 2. El Input oculto para enviar el ID -->
                    <input type="hidden" class="producto-id-hidden" name="producto_id_existente[]" value="0">
                </div>
                <!-- ======================== -->
                
                <!-- Input de Producto Nuevo (oculto por defecto) -->
                <div class="control-nuevo" style="display: none;">
                    <label class="form-label">Descripción del Producto Nuevo</label>
                    <input type="text" name="producto_nuevo_descripcion[]" class="form-control" disabled>
                    <!-- 3. Un input oculto (deshabilitado) para mantener el array del form alineado -->
                    <input type="hidden" name="producto_id_existente[]" value="0" disabled>
                </div>
            </div>
            
            <!-- Columna 2: Proveedor (con Datalist) -->
            <div class="col-md-3">
                <label class="form-label">Proveedor (Existente o Nuevo)</label>
                <input class="form-control" list="datalistProveedores" name="proveedor_sugerido[]" placeholder="Escribe o selecciona...">
            </div>
            
            <!-- Columna 3: Cantidad y Costo -->
            <div class="col-md-4">
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="cantidad[]" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" name="costo[]" class="form-control costo-input" value="0.00" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            
            <!-- Botón Eliminar -->
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarLinea(this)">
                    <i class="bi bi-trash"></i> Eliminar Línea
                </button>
            </div>
        </div>
    </template>

    <!-- DATALIST (global) para Proveedores -->
    <datalist id="datalistProveedores">
        {% for prov in proveedores %}
            <option value="{{ prov.nombre }}">
        {% endfor %}
    </datalist>
    
    <!-- DATALIST (global) para Productos -->
    <datalist id="datalistProductos">
        {% for p in productos %}
            <option value="{{ p.nombre }} (SKU: {{ p.codigo }})">
        {% endfor %}
    </datalist>

    <!-- ============================================= -->
    <!-- JAVASCRIPT MODIFICADO PARA BÚSQUEDA -->
    <!-- ============================================= -->
    <script>
        // Contador global para asegurar IDs/Names únicos
        let lineaCounter = 0;
        
        // Ponemos los productos en un mapa de JS para búsqueda rápida
        const productosMap = new Map();
        {% for p in productos %}
            productosMap.set("{{ p.nombre }} (SKU: {{ p.codigo }})", { id: {{ p.id }}, precio: {{ p.precio_unitario }} });
        {% endfor %}

        // Función global para eliminar línea
        function eliminarLinea(boton) {
            boton.closest('.item-linea').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const contenedor = document.getElementById('lineas_items_container');
            const plantilla = document.getElementById('plantilla_linea');
            
            function anadirNuevaLinea() {
                lineaCounter++;
                const nuevaLinea = plantilla.content.firstElementChild.cloneNode(true);

                // --- 1. Actualizar IDs y 'name' de radios ---
                nuevaLinea.querySelector('#tipo_existente_X').id = `tipo_existente_${lineaCounter}`;
                nuevaLinea.querySelector('label[for="tipo_existente_X"]').htmlFor = `tipo_existente_${lineaCounter}`;
                nuevaLinea.querySelector('#tipo_nuevo_X').id = `tipo_nuevo_${lineaCounter}`;
                nuevaLinea.querySelector('label[for="tipo_nuevo_X"]').htmlFor = `tipo_nuevo_${lineaCounter}`;
                
                const radioName = `tipo_item_group_${lineaCounter}`;
                nuevaLinea.querySelectorAll('.tipo-item').forEach(radio => radio.name = radioName);
                
                // --- 2. Referencias a los controles ---
                const radios = nuevaLinea.querySelectorAll('.tipo-item');
                const tipoHidden = nuevaLinea.querySelector('.tipo-item-hidden');
                const divExistente = nuevaLinea.querySelector('.control-existente');
                const divNuevo = nuevaLinea.querySelector('.control-nuevo');
                
                const inputExistente = divExistente.querySelector('.producto-search');
                const inputExistenteId = divExistente.querySelector('.producto-id-hidden');
                
                const inputNuevo = divNuevo.querySelector('input');
                const inputNuevoId = divNuevo.querySelector('input[type="hidden"]'); // El input oculto deshabilitado
                
                const inputCosto = nuevaLinea.querySelector('.costo-input');

                // --- 3. Lógica de cambio de Tipo (Existente vs Nuevo) ---
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        tipoHidden.value = this.value;
                        if (this.value === 'existente') {
                            divExistente.style.display = 'block';
                            inputExistente.disabled = false;
                            inputExistenteId.disabled = false;
                            
                            divNuevo.style.display = 'none';
                            inputNuevo.disabled = true;
                            inputNuevoId.disabled = true;

                            // Auto-rellenar precio si ya hay algo
                            buscarProducto(inputExistente.value);
                            
                        } else if (this.value === 'nuevo') {
                            divExistente.style.display = 'none';
                            inputExistente.disabled = true;
                            inputExistenteId.disabled = true;
                            
                            divNuevo.style.display = 'block';
                            inputNuevo.disabled = false;
                            inputNuevoId.disabled = false;

                            inputCosto.value = '0.00';
                            inputCosto.readOnly = false;
                            inputExistenteId.value = '0';
                        }
                    });
                });
                
                // --- 4. Lógica de búsqueda y auto-rellenado ---
                function buscarProducto(valor) {
                    const producto = productosMap.get(valor);
                    if (producto) {
                        // Encontrado: Rellenar ID y Costo
                        inputExistenteId.value = producto.id;
                        inputCosto.value = parseFloat(producto.precio).toFixed(2);
                        inputCosto.readOnly = true;
                    } else {
                        // No encontrado: Limpiar ID (el costo se queda editable)
                        inputExistenteId.value = '0';
                        // (Opcional: puedes forzar el costo a 0 si quieres)
                        // inputCosto.value = '0.00'; 
                        inputCosto.readOnly = false;
                    }
                }
                
                // Usamos 'input' para que se active al escribir O al seleccionar del datalist
                inputExistente.addEventListener('input', function() {
                    buscarProducto(this.value);
                });
                
                // Llamada inicial para auto-rellenar el costo (si el producto '0' tiene precio)
                buscarProducto(inputExistente.value);

                contenedor.appendChild(nuevaLinea);
            }

            document.getElementById('btn_add_item').addEventListener('click', anadirNuevaLinea);
            anadirNuevaLinea(); // Cargar la primera línea automáticamente
        });
    </script>
{% endblock %}
