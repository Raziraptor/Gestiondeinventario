{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <h2>{{ titulo }}</h2>
    <hr>

    <form method="POST" action="{{ url_for('editar_orden', id=orden.id) if orden else url_for('nueva_orden_manual') }}">
        
        <div class="row">
            <div class="mb-3 col-md-6">
                <label for="proveedor_id" class="form-label">Proveedor</label>
                <select class="form-select" id="proveedor_id" name="proveedor_id" 
                        {% if orden %}disabled{% endif %} required>
                    <option value="">-- Selecciona un proveedor --</option>
                    {% for prov in proveedores %}
                        <option value="{{ prov.id }}" 
                                {% if orden and orden.proveedor_id == prov.id %}selected{% endif %}>
                            {{ prov.nombre }}
                        </option>
                    {% endfor %}
                </select>
                {% if orden %}
                    <input type="hidden" name="proveedor_id" value="{{ orden.proveedor_id }}">
                    <small class="form-text text-muted">No se puede cambiar el proveedor de una orden existente.</small>
                {% endif %}
            </div>
            
            <div class="mb-3 col-md-6">
                <label for="almacen_id" class="form-label">Almacén de Destino</label>
                <select class="form-select" id="almacen_id" name="almacen_id" 
                        {% if orden %}disabled{% endif %} required>
                    <option value="">-- Selecciona un almacén --</option>
                    {% for alm in almacenes %}
                        <option value="{{ alm.id }}" 
                                {% if orden and orden.almacen_id == alm.id %}selected{% endif %}>
                            {{ alm.nombre }}
                        </option>
                    {% endfor %}
                </select>
                {% if orden %}
                     <input type="hidden" name="almacen_id" value="{{ orden.almacen_id }}">
                    <small class="form-text text-muted">No se puede cambiar el almacén de una orden existente.</small>
                {% endif %}
            </div>
        </div>

        <hr>
        
        <h4>Productos</h4>
        <div id="lineas_productos_container">
            {% if orden %}
                {% for detalle in orden.detalles %}
                <div class="row g-3 mb-2 align-items-end producto-linea">
                    <div class="col-md-5">
                        <label class="form-label">Producto</label>
                        <select name="producto_id[]" class="form-select" required>
                            <option value="">-- Selecciona --</option>
                            {% for p in productos %}
                                {% if p.proveedor_id == orden.proveedor_id %}
                                <option value="{{ p.id }}" data-precio="{{ p.precio_unitario }}" {% if p.id == detalle.producto_id %}selected{% endif %}>
                                    {{ p.nombre }} (SKU: {{ p.codigo }})
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="cantidad[]" class="form-control" value="{{ detalle.cantidad_solicitada }}" min="1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" name="costo[]" class="form-control costo-input" value="{{ "%.2f"|format(detalle.costo_unitario_estimado) }}" step="0.01" min="0" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger w-100" onclick="eliminarLinea(this)">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        
        <button type="button" id="btn_add_producto" class="btn btn-info mt-2" disabled>
            <i class="bi bi-plus-circle"></i> Añadir Producto
        </button>
        <small id="producto_ayuda" class="form-text text-muted d-block mt-2">
            Primero selecciona un Proveedor y un Almacén.
        </small>
        
        
        <hr class="my-4">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Guardar Orden</button>
            <a href="{{ url_for('lista_ordenes') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <template id="plantilla_linea">
        <div class="row g-3 mb-2 align-items-end producto-linea">
            <div class="col-md-5">
                <label class="form-label">Producto</label>
                <select name="producto_id[]" class="form-select" required>
                    </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cantidad</label>
                <input type="number" name="cantidad[]" class="form-control" value="1" min="1" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Costo Unitario</label>
                <input type="number" name="costo[]" class="form-control costo-input" value="0.00" step="0.01" min="0" required>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger w-100" onclick="eliminarLinea(this)">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </template>


    <script>
        var todosLosProductos = {{ productos | tojson | safe }};

        function eliminarLinea(boton) {
            boton.closest('.producto-linea').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const selectProveedor = document.getElementById('proveedor_id');
            const selectAlmacen = document.getElementById('almacen_id');
            const botonAnadir = document.getElementById('btn_add_producto');
            const productoAyuda = document.getElementById('producto_ayuda');
            const contenedor = document.getElementById('lineas_productos_container');
            const plantilla = document.getElementById('plantilla_linea');

            // --- 1. Verifica si podemos habilitar el botón ---
            function actualizarEstadoBoton() {
                if (selectProveedor.value && selectAlmacen.value) {
                    botonAnadir.disabled = false;
                    productoAyuda.style.display = 'none';
                } else {
                    botonAnadir.disabled = true;
                    productoAyuda.style.display = 'block';
                }
            }

            // --- 2. Añade una nueva línea filtrada ---
            function anadirNuevaLinea() {
                const proveedorId = selectProveedor.value;
                // Si no hay proveedor seleccionado, no hacemos nada (seguridad extra)
                if (!proveedorId) return;

                const nuevaLinea = plantilla.content.firstElementChild.cloneNode(true);
                const selectProducto = nuevaLinea.querySelector('select[name="producto_id[]"]');
                const inputCosto = nuevaLinea.querySelector('.costo-input');

                // Opción por defecto
                selectProducto.add(new Option('-- Selecciona --', ''));

                // FILTRADO ESTRICTO: Solo productos de ESTE proveedor
                let productosEncontrados = 0;
                todosLosProductos.forEach(function(producto) {
                    // Comparación flexible (==) porque uno puede ser string y otro int
                    if (producto.proveedor_id == proveedorId) {
                        const opcion = new Option(
                            `${producto.nombre} (SKU: ${producto.codigo})`,
                            producto.id
                        );
                        opcion.dataset.precio = producto.precio_unitario;
                        selectProducto.add(opcion);
                        productosEncontrados++;
                    }
                });

                if (productosEncontrados === 0) {
                    alert("Este proveedor no tiene productos registrados.");
                    return; // No añadimos la línea vacía
                }

                // Auto-rellenar costo
                selectProducto.addEventListener('change', function() {
                    const precio = this.options[this.selectedIndex].dataset.precio || 0;
                    inputCosto.value = parseFloat(precio).toFixed(2);
                });
                
                contenedor.appendChild(nuevaLinea);
            }

            // --- Listeners ---
            botonAnadir.addEventListener('click', anadirNuevaLinea);

            // Si cambiamos proveedor u almacén, reseteamos las líneas para evitar errores
            selectProveedor.addEventListener('change', function() {
                contenedor.innerHTML = ''; 
                actualizarEstadoBoton();
            });
            selectAlmacen.addEventListener('change', function() {
                 // Opcional: si quieres que cambiar de almacén TAMBIÉN borre las líneas, descomenta la siguiente:
                 // contenedor.innerHTML = '';
                 actualizarEstadoBoton();
            });

            // --- Carga Inicial ---
            actualizarEstadoBoton();
            
            // Si estamos editando, necesitamos reactivar los listeners de costo para las líneas existentes
            {% if orden %}
                 contenedor.querySelectorAll('.producto-linea').forEach(function(linea) {
                    const select = linea.querySelector('select[name="producto_id[]"]');
                    const inputCosto = linea.querySelector('.costo-input');
                    select.addEventListener('change', function() {
                        const precio = this.options[this.selectedIndex].dataset.precio || 0;
                        inputCosto.value = parseFloat(precio).toFixed(2);
                    });
                });
            {% endif %}
        });
    </script>
{% endblock %}
